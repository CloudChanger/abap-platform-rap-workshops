# TOC
[Home](../../readme.md#exercises)
# Adapt the generated code

In this exercise we will perform changes to the generated code so that our application becomes usable. 

- _Projection view_:  
Here we will add value help definitions for the currency code and quantity units.

- _Behavior Definition_ and _Behavior Implementation_:  
Here we will make the semantic key field **InventoryID** _read_only_ and we will add a determination to the behavior definition and implement the same in the behavior implementation clas so that the semantic key field **InventoryID** will be filled automatically.

## Projection view

In the source code of the projection view ````ZRAP620_C_INVENTORYTP_### ```` we will add two value help definitions for the fields ````QuantityUnit```` and ````CurrencyCode````. 

You can either open the source code editor from the Project Explorer or you can use the short cut **Ctrl+Shift+A**  which starts the dialogue to open an ABAP development object and search for ````ZRAP620_C_INVENTORYTP_### ````.   
 <details>
  <summary>Click to expand the source code ...</summary>
<pre lang="ABAP">
@AccessControl.authorizationCheck: #CHECK
@Metadata.allowExtensions: true
@EndUserText.label: '@EndUserText.label: 'Projection View for Inventory'
define root view entity ZRAP620_C_INVENTORYTP_###
  provider contract transactional_query
  as projection on ZRAP620_R_INVENTORYTP_###
{
  key UUID,
      InventoryID,
      ProductID,
      Quantity,
      @Consumption.valueHelpDefinition: [ {
      entity: {
        name: 'I_UnitOfMeasure',
        element: 'UnitOfMeasure'
      }
      } ]
      QuantityUnit,
      Price,
      @Consumption.valueHelpDefinition: [ {
      entity: {
        name: 'I_Currency',
        element: 'Currency'
      }
      } ]
      CurrencyCode,
      Description,
      OverallStatus,
      LastChangedAt

}


</pre>
</details>

## Behavior definition

Open the behavior defintion ````ZRAP620_R_INVENTORYTP_### ```` and add the field **InventoryID** to the list of fields that are marked as readonly and add a determination **CalculateInventoryID** for the field **InventoryID**.

<details>
  <summary>Click to expand the steps ...</summary>

1. Add **InventoryID** to the list of read-only fields:

<pre>
 field ( readonly )
  InventoryID, //semantic key
  UUID,
  CreatedAt,
  CreatedBy,
  LocalLastChangedAt,
  LastChangedAt,
  LastChangedBy;

</pre>


2. add the following line of code right before the mapping section.

<pre>
determination CalculateInventoryID on save { create; }
</pre>

> Once you have added the determination to the behavior definition you will get a warning that the determination is not implemented yet.


   ![Open Behavior Implementation](images/bdef_add_determination_0000.png)

3. Click on the warning icon 

4. Choose the quick fix **add method for determination caculateinventoryid of entity ZRAP620_R_INVENTORYTP_###**  

   ![Open Behavior Implementation](images/bdef_add_determination_0010.png)
   

5. The editor for the behavior implementation class opens.

6. *Save* your changes and proceed with the following section to maintain the behavior implementation.   

</details>

## Behavior implementation

The behavior implementation class ````ZRAP620_BP_INVENTORYTP_###```` is automatically opened with the tab **Local Types** for the local handler class ````lcl_handler```` .
The quick fix has added a method ````CalculateInventoryID```` with an (empty) implementation for the determination that shall calculate the semantic key InventoryID. 

<details>
  <summary>Click to expand the steps ...</summary>

 ![Open Behavior Implementation](images/bdef_add_determination_0020.png)

1. Add the code shown below to implement the determination for the field **InventoryID**
  
> The implementation of the behavior defintion must (for technical reasons) take place in local classes that follow the naming convention **lhc_handler** when being generated with the wizard and **lhc_\<EntityName\>** (here **lhc_Inventory**) if being generated by ADT using a quick fix.  
> We suggest to use the source code shown below to implement the calculation of the semantic key of our managed business object for inventory data. In a productive application you would rather use a number range.  
> To keep our implementation simple we will use the approach to simply count the number of objects that are available.   
> By a simple increment of this number we get a semantic key which is readable by the users of our application.



 <pre lang="ABAP"> 
 
METHOD CalculateInventoryID.

    "Ensure idempotence
    READ ENTITIES OF zrap620_r_inventorytp_### IN LOCAL MODE
      ENTITY Inventory
        FIELDS ( InventoryID )
        WITH CORRESPONDING #( keys )
      RESULT DATA(inventories).

    DELETE inventories WHERE InventoryID IS NOT INITIAL.
    CHECK inventories IS NOT INITIAL.

    "Get max travelID
    SELECT SINGLE FROM zrap620_inven### FIELDS MAX( inventory_id ) INTO @DATA(max_inventory).

    "update involved instances
    MODIFY ENTITIES OF zrap620_r_inventorytp_### IN LOCAL MODE
      ENTITY Inventory
        UPDATE FIELDS ( InventoryID )
        WITH VALUE #( FOR inventory IN inventories INDEX INTO i (
                           %tky      = inventory-%tky
                           inventoryID  = max_inventory + i ) )
    REPORTED DATA(lt_reported).

    "fill reported
    reported = CORRESPONDING #( DEEP lt_reported ).


ENDMETHOD.
 
</pre>
   
 7. Replace the placeholders <b>####</b> with your group number **(Ctrl+F)**.
 
 8. Activate your changes **(Ctrl+F3)**

 ![Replace the placeholders](images/bil_replace_placeholders_0000.png)

</details>

# Test your changes

After having performed all the changes mentioned above we can use the SAP Fiori Elements preview in ADT to test our updated implementation.   

<details>
  <summary>Click to expand the steps ...</summary>

1. Open the service binding **`ZRAP620_UI_INVENTOR_O4_###`**
2. Start the SAP Fiori elements preview.
   - Select the entity set **Inventory**  
   - Press the **Preview** button 

   ![Test implementation - Step 1](images/preview_fe_000.png)

3. Test the implementation. 
  - Press the **Create** button.
  - Enter an arbritray product name
  - Press **Create**
  
    ![Test implementation - Step 2](images/preview_fe_005.png)
    ![Test implementation - Step 3](images/preview_fe_010.png)
  
2. Check the numbering for the semantic key **InventoryID**.

 
   ![Test implementation - Step 4](images/preview_fe_020.png)

</details>
